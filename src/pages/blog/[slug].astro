---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Nav from "../../components/Nav.astro";
import { getCollection } from "astro:content";
import { Picture } from "astro:assets";
import type { ImageMetadata } from "astro";
import bokehBg from "../../assets/images/composition/bokeh_bg.png";
import Footer from "../../components/Footer.astro";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  const activePosts = posts.filter((post) => post.data.active);

  return activePosts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

// Cargar todas las imágenes de posts
const postImages = import.meta.glob<{ default: ImageMetadata }>(
  "../../assets/images/posts/*.{jpeg,jpg,png,webp}",
);

// Helper para resolver la imagen
function resolveImage(url: string | undefined) {
  if (!url) return null;
  const filename = url.split("/").pop();
  const path = `../../assets/images/posts/${filename}`;
  const imageLoader = postImages[path];

  if (!imageLoader) {
    return null;
  }

  return imageLoader();
}

// Obtener artículos relacionados activos
const allPosts = await getCollection("blog");
const relatedPosts = allPosts
  .filter((p) => p.data.active && p.slug !== post.slug)
  .slice(0, 3);

const heroImagePromise = resolveImage(post.data.image);
const heroImageRes = heroImagePromise ? await heroImagePromise : null;
const heroImageUrl = heroImageRes?.default?.src;

// Formatear fecha para Schema.org
const months: Record<string, string> = {
  enero: "01",
  febrero: "02",
  marzo: "03",
  abril: "04",
  mayo: "05",
  junio: "06",
  julio: "07",
  agosto: "08",
  septiembre: "09",
  octubre: "10",
  noviembre: "11",
  diciembre: "12",
};
// Try to parse Spanish date if present, otherwise assume it might be ISO or leave it
const dateParts = post.data.date?.match(/(\d+) de ([a-z]+) de (\d+)/i);
let isoDate = post.data.date;
if (dateParts) {
  const day = dateParts[1].padStart(2, "0");
  const month = months[dateParts[2].toLowerCase()];
  const year = dateParts[3];
  if (month) isoDate = `${year}-${month}-${day}`;
}

const schema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: post.data.title,
  description: post.data.excerpt,
  image: heroImageUrl
    ? [
        new URL(
          heroImageUrl,
          Astro.site || "https://biomagnetico.es",
        ).toString(),
      ]
    : [],
  datePublished: isoDate,
  author: {
    "@type": "Person",
    name: post.data.author,
  },
  publisher: {
    "@type": "Organization",
    name: "Par Biomagnético",
    logo: {
      "@type": "ImageObject",
      url: "https://biomagnetico.es/favicon.png",
    },
  },
};
---

<BaseLayout
  title={`${post.data.title} | Par Biomagnético`}
  description={post.data.excerpt}
  image={heroImageUrl}
>
  <script type="application/ld+json" set:html={JSON.stringify(schema)} />

  <main class="article-page">
    <!-- Hero con Bokeh (título del artículo) -->
    <section class="article-hero">
      <Picture
        src={bokehBg}
        formats={["avif", "webp"]}
        widths={[720, 1280, 1920]}
        sizes="100vw"
        alt="Fondo de energía y bienestar"
        class="bokeh-bg"
        loading="eager"
        fetchpriority="high"
      />
      <div class="hero-overlay"></div>

      <!-- Sparkles/Destellos flotantes -->
      <div class="sparkles">
        <span class="sparkle"></span>
        <span class="sparkle"></span>
        <span class="sparkle"></span>
        <span class="sparkle"></span>
        <span class="sparkle"></span>
        <span class="sparkle"></span>
      </div>

      <Nav currentPage="blog" />

      <div class="hero-content">
        <h1 class="article-title">{post.data.title}</h1>
        <div class="article-meta">
          <span>Por {post.data.author}</span>
          <span class="separator">|</span>
          <span>{post.data.date}</span>
        </div>
      </div>
    </section>

    <!-- Contenido con gradiente -->
    <section class="content-section">
      <div class="content-container">
        <div class="article-layout">
          <!-- Contenido principal -->
          <article class="article-content">
            <div class="prose">
              <Content />
            </div>

            <blockquote class="featured-quote">
              "La salud no es la ausencia de enfermedad, sino la resonancia
              armónica de nuestros campos magnéticos celulares."
            </blockquote>

            <figure class="article-image">
              {
                heroImagePromise && (
                  <Picture
                    src={heroImagePromise}
                    formats={["avif", "webp"]}
                    widths={[600, 1000]}
                    sizes="(max-width: 900px) 100vw, 800px"
                    alt={`Ilustración: ${post.data.title}`}
                    class="article-img-element"
                    loading="eager"
                  />
                )
              }
            </figure>
          </article>

          <!-- Sidebar -->
          <aside class="article-sidebar">
            <div class="sidebar-section">
              <h3 class="sidebar-title">Artículos<br />Relacionados</h3>
              <div class="related-posts">
                {
                  relatedPosts.map((related) => {
                    const relatedImg = resolveImage(related.data.image);
                    return (
                      <a href={`/blog/${related.slug}`} class="related-post">
                        {relatedImg && (
                          <Picture
                            src={relatedImg}
                            formats={["avif", "webp"]}
                            widths={[240, 480]}
                            sizes="240px"
                            alt={`Relacionado: ${related.data.title}`}
                            class="related-img-element"
                            loading="lazy"
                          />
                        )}
                      </a>
                    );
                  })
                }
              </div>
            </div>
          </aside>
        </div>

        <div class="back-link-container">
          <a href="/blog" class="back-link">← Volver al Blog</a>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <Footer />
  </main>
</BaseLayout>

<style>
  .article-page {
    min-height: 100vh;
  }

  /* === HERO CON BOKEH === */
  .article-hero {
    position: relative;
    min-height: 40vh;
    display: flex;
    align-items: flex-end;
    padding-bottom: 3rem;
  }

  .bokeh-bg {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: 0;
  }

  .hero-overlay {
    position: absolute;
    inset: 0;
    z-index: 1;
    background: linear-gradient(
      to bottom,
      rgba(10, 10, 12, 0.3) 0%,
      rgba(10, 10, 12, 0.5) 70%,
      #2c2416 100%
    );
  }

  .hero-content {
    position: relative;
    z-index: 10;
    max-width: 1100px;
    margin: 0 auto;
    padding: 0 3rem;
    width: 100%;
  }

  .article-title {
    font-family: "Playfair Display", Georgia, serif;
    font-size: clamp(1.6rem, 3.5vw, 2.4rem);
    font-weight: 400;
    color: #d4a853;
    line-height: 1.3;
    margin-bottom: 1rem;
    max-width: 800px;
  }

  .article-meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.7);
  }

  .separator {
    color: rgba(255, 255, 255, 0.3);
  }

  /* === CONTENIDO CON GRADIENTE === */
  .content-section {
    background: linear-gradient(
      to bottom,
      #2c2416 0%,
      #1e3a2f 30%,
      #1a2e26 60%,
      #0f1f1a 100%
    );
    padding: 3rem 0 4rem;
  }

  .content-container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 0 3rem;
  }

  /* Layout 2 columnas */
  .article-layout {
    display: grid;
    grid-template-columns: 1fr 240px;
    gap: 2.5rem;
  }

  @media (max-width: 900px) {
    .article-layout {
      grid-template-columns: 1fr;
    }

    .hero-content,
    .content-container {
      padding: 0 1.5rem;
    }
  }

  /* Contenido del artículo */
  .article-content {
    background: linear-gradient(
      135deg,
      rgba(255, 255, 255, 0.04) 0%,
      rgba(255, 255, 255, 0.01) 100%
    );
    border: 1px solid rgba(212, 168, 83, 0.15);
    border-radius: 1rem;
    padding: 2rem 2rem;
    backdrop-filter: blur(10px);
    position: relative;
  }

  .article-content::before {
    content: "";
    position: absolute;
    left: 0;
    top: 2rem;
    bottom: 2rem;
    width: 3px;
    background: linear-gradient(
      to bottom,
      transparent,
      #d4a853,
      #4ade80,
      transparent
    );
    border-radius: 2px;
  }

  .prose {
    font-size: 0.95rem;
    color: rgba(255, 255, 255, 0.8);
    line-height: 1.75;
  }

  .prose :global(p) {
    margin-bottom: 1.25rem;
  }

  .prose :global(h2) {
    font-family: "Playfair Display", Georgia, serif;
    font-size: 1.35rem;
    color: #d4a853;
    margin-top: 2rem;
    margin-bottom: 0.85rem;
  }

  .prose :global(h3) {
    font-size: 1.15rem;
    color: #fff;
    margin-top: 1.75rem;
    margin-bottom: 0.65rem;
  }

  .prose :global(ul),
  .prose :global(ol) {
    margin-bottom: 1.25rem;
    padding-left: 1.5rem;
  }

  .prose :global(li) {
    margin-bottom: 0.4rem;
  }

  .prose :global(a) {
    color: #d4a853;
    text-decoration: underline;
  }

  .prose :global(strong) {
    color: #fff;
  }

  /* Cita destacada */
  .featured-quote {
    margin: 2rem 0;
    padding: 1.25rem 1.75rem;
    background: rgba(212, 168, 83, 0.08);
    border-left: 3px solid #d4a853;
    font-family: "Playfair Display", Georgia, serif;
    font-size: 1rem;
    font-style: italic;
    color: rgba(255, 255, 255, 0.85);
    line-height: 1.6;
    border-radius: 0 0.5rem 0.5rem 0;
  }

  /* Imagen del artículo */
  .article-image {
    margin: 1.5rem 0 0;
    border-radius: 0.75rem;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.05);
  }

  .article-image img {
    width: 100%;
    height: auto;
    display: block;
  }

  /* Sidebar */
  .article-sidebar {
    position: sticky;
    top: 100px;
    align-self: start;
  }

  .sidebar-section {
    background: linear-gradient(
      135deg,
      rgba(255, 255, 255, 0.04) 0%,
      rgba(255, 255, 255, 0.01) 100%
    );
    border: 1px solid rgba(212, 168, 83, 0.15);
    border-radius: 1rem;
    padding: 1.25rem;
    backdrop-filter: blur(10px);
  }

  .sidebar-title {
    font-family: "Playfair Display", Georgia, serif;
    font-size: 1rem;
    font-weight: 400;
    color: #fff;
    margin-bottom: 1rem;
    line-height: 1.35;
  }

  .related-posts {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .related-post {
    display: block;
    border-radius: 0.5rem;
    overflow: hidden;
    transition:
      transform 0.3s ease,
      opacity 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.05);
  }

  .related-post:hover {
    transform: scale(1.03);
  }

  .related-post img {
    width: 100%;
    height: 80px;
    object-fit: cover;
    display: block;
  }

  /* Botón volver */
  .back-link-container {
    margin-top: 2.5rem;
  }

  .back-link {
    display: inline-block;
    font-size: 0.85rem;
    font-weight: 600;
    color: #d4a853;
    text-decoration: none;
    transition: color 0.3s ease;
  }

  .back-link:hover {
    color: #e8c278;
  }

  /* === SPARKLES/DESTELLOS (estilo suave como inicio) === */
  .sparkles {
    position: absolute;
    inset: 0;
    z-index: 2;
    pointer-events: none;
    overflow: hidden;
  }

  .sparkle {
    position: absolute;
    width: 3px;
    height: 3px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.9);
    box-shadow:
      0 0 6px 1px rgba(255, 255, 255, 0.6),
      0 0 12px 2px rgba(255, 255, 200, 0.4);
    animation: sparkle 3s ease-in-out infinite;
  }

  .sparkle:nth-child(1) {
    left: 15%;
    top: 25%;
    animation-delay: 0s;
    width: 3px;
    height: 3px;
  }
  .sparkle:nth-child(2) {
    left: 80%;
    top: 35%;
    animation-delay: 0.5s;
    width: 2px;
    height: 2px;
  }
  .sparkle:nth-child(3) {
    left: 45%;
    top: 55%;
    animation-delay: 1s;
    width: 4px;
    height: 4px;
  }
  .sparkle:nth-child(4) {
    left: 65%;
    top: 70%;
    animation-delay: 1.5s;
    width: 3px;
    height: 3px;
  }
  .sparkle:nth-child(5) {
    left: 25%;
    top: 75%;
    animation-delay: 2s;
    width: 2px;
    height: 2px;
  }
  .sparkle:nth-child(6) {
    left: 55%;
    top: 20%;
    animation-delay: 2.5s;
    width: 3px;
    height: 3px;
  }

  @keyframes sparkle {
    0%,
    100% {
      opacity: 0.15;
      transform: scale(0.6);
    }
    50% {
      opacity: 0.9;
      transform: scale(1.1);
    }
  }

  /* === GLOW EN TÍTULO === */
  .article-title {
    text-shadow:
      0 0 20px rgba(212, 168, 83, 0.3),
      0 0 40px rgba(212, 168, 83, 0.15),
      0 0 60px rgba(212, 168, 83, 0.1);
    animation: title-glow 4s ease-in-out infinite alternate;
  }

  @keyframes title-glow {
    from {
      text-shadow:
        0 0 20px rgba(212, 168, 83, 0.3),
        0 0 40px rgba(212, 168, 83, 0.15);
    }
    to {
      text-shadow:
        0 0 25px rgba(212, 168, 83, 0.4),
        0 0 50px rgba(212, 168, 83, 0.2),
        0 0 70px rgba(212, 168, 83, 0.1);
    }
  }
</style>
