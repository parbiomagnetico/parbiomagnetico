---
import { Image } from "astro:assets";
import bodyFront from "../assets/images/body_front_new.webp";
import bodyBack from "../assets/images/body_back_new.webp";
import coordinates from "../data/points_coordinates.json";

// Pass coordinates to client
const coordinatesJSON = JSON.stringify(coordinates);
---

<div id="body-visualizer-modal" class="visualizer-modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
        <button id="close-modal" class="close-btn">&times;</button>

        <div class="modal-header">
            <h3 id="modal-pair-title" class="modal-title">
                <span id="modal-point-a">Punto A</span>
                <span class="connector">-</span>
                <span id="modal-point-b">Punto B</span>
            </h3>
            <p id="modal-pathology" class="modal-subtitle">Patolog√≠a</p>
        </div>

        <div class="visualizer-body">
            <!-- Front View -->
            <div class="body-view">
                <div class="body-img-wrapper">
                    <Image
                        src={bodyFront}
                        alt="Vista Frontal"
                        class="body-img"
                    />
                    <div id="marker-front-a" class="marker hidden"></div>
                    <div id="marker-front-b" class="marker hidden"></div>
                </div>
                <span class="view-label">FRONTAL</span>
            </div>

            <!-- Back View -->
            <div class="body-view">
                <div class="body-img-wrapper">
                    <Image src={bodyBack} alt="Vista Dorsal" class="body-img" />
                    <div id="marker-back-a" class="marker hidden"></div>
                    <div id="marker-back-b" class="marker hidden"></div>
                </div>
                <span class="view-label">DORSAL</span>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item">
                <span class="dot a"></span> Punto A (Norte/Negativo)
            </div>
            <div class="legend-item">
                <span class="dot b"></span> Punto B (Sur/Positivo)
            </div>
        </div>
    </div>
</div>

<script define:vars={{ coordinatesJSON }}>
    const coords = JSON.parse(coordinatesJSON);

    const modal = document.getElementById("body-visualizer-modal");
    const closeBtn = document.getElementById("close-modal");
    const backdrop = document.querySelector(".modal-backdrop");

    // Elements to update
    const titleA = document.getElementById("modal-point-a");
    const titleB = document.getElementById("modal-point-b");
    const subTitle = document.getElementById("modal-pathology");

    // Markers
    const mFA = document.getElementById("marker-front-a");
    const mFB = document.getElementById("marker-front-b");
    const mBA = document.getElementById("marker-back-a");
    const mBB = document.getElementById("marker-back-b");

    function getPointCoords(pointName) {
        if (coords.Frontal[pointName])
            return { view: "front", ...coords.Frontal[pointName] };
        if (coords.Dorsal[pointName])
            return { view: "back", ...coords.Dorsal[pointName] };
        // Try fuzzy match/normalization if needed, or default to null
        // Simple normalization: Remove accents? No, keys have accents.
        return null;
    }

    function setMarker(element, pointInfo, typeClass) {
        if (pointInfo) {
            element.style.left = `${pointInfo.x}%`;
            // Use 'top' for y
            element.style.top = `${pointInfo.y}%`;
            element.className = `marker ${typeClass}`; // Remove hidden
        } else {
            element.className = `marker hidden`;
        }
    }

    // Expose toggle function globally or event listener?
    // Let's use a custom event on document
    document.addEventListener("open-visualizer", (e) => {
        const { pointA, pointB, pathology, type } = e.detail;

        // Update Text
        if (titleA) titleA.textContent = pointA;
        if (titleB) titleB.textContent = pointB;
        if (subTitle) subTitle.textContent = `${type} - ${pathology}`;

        // Resolve Coordinates
        let infoA = getPointCoords(pointA);
        let infoB = getPointCoords(pointB);

        // Handle BILATERAL pairs (same point on both sides)
        // Mirror the X coordinate for point B
        const isBilateral = pointA === pointB && infoA;
        if (isBilateral && infoB) {
            // Mirror X: if original is 35%, mirrored is 65% (100 - 35)
            infoB = { ...infoB, x: 100 - infoB.x };
        }

        // Reset all markers
        [mFA, mFB, mBA, mBB].forEach((m) => m?.classList.add("hidden"));

        // Set A
        if (infoA) {
            if (infoA.view === "front" && mFA) setMarker(mFA, infoA, "is-a");
            if (infoA.view === "back" && mBA) setMarker(mBA, infoA, "is-a");
        }

        // Set B
        if (infoB) {
            if (infoB.view === "front" && mFB) setMarker(mFB, infoB, "is-b");
            if (infoB.view === "back" && mBB) setMarker(mBB, infoB, "is-b");
        }

        modal?.classList.remove("hidden");
    });

    // Close logic
    function closeModal() {
        modal?.classList.add("hidden");
    }

    closeBtn?.addEventListener("click", closeModal);
    backdrop?.addEventListener("click", closeModal);
    document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeModal();
    });
</script>

<style>
    .visualizer-modal {
        position: fixed;
        inset: 0;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: "Inter", sans-serif;
    }

    .visualizer-modal.hidden {
        display: none;
    }

    .modal-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(8px);
        z-index: 0;
    }

    .modal-content {
        position: relative;
        z-index: 1;
        background: rgba(15, 31, 26, 0.95);
        border: 1px solid rgba(74, 222, 128, 0.3);
        border-radius: 1.5rem;
        padding: 2rem;
        width: 90%;
        max-width: 900px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .close-btn {
        position: absolute;
        top: 1rem;
        right: 1.5rem;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: rgba(255, 255, 255, 0.8);
        font-size: 1.5rem;
        cursor: pointer;
        line-height: 1;
        transition: all 0.2s;
        z-index: 100;
    }

    .close-btn:hover {
        background: rgba(239, 68, 68, 0.8);
        border-color: #ef4444;
        color: #fff;
    }

    /* Mobile adjustments - move button inside modal content area */
    @media (max-width: 768px) {
        .close-btn {
            top: 0.5rem;
            right: 0.5rem;
            width: 44px;
            height: 44px;
            font-size: 1.8rem;
        }

        .modal-content {
            padding-top: 3.5rem;
        }
    }

    .modal-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .modal-title {
        font-family: "Playfair Display", serif;
        font-size: 1.8rem;
        color: #d4a853;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.8rem;
    }

    .modal-subtitle {
        color: rgba(255, 255, 255, 0.7);
        margin-top: 0.5rem;
        font-size: 1.1rem;
    }

    .connector {
        opacity: 0.5;
    }

    .visualizer-body {
        display: flex;
        justify-content: center;
        gap: 3rem;
        width: 100%;
        margin-bottom: 2rem;
    }

    @media (max-width: 768px) {
        .visualizer-body {
            flex-direction: column;
            align-items: center;
            gap: 2rem;
        }
    }

    .body-view {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 250px;
    }

    .body-img-wrapper {
        position: relative;
        width: 100%;
    }

    .body-img {
        width: 100%;
        height: auto;
        display: block;
        border-radius: 8px;
    }

    .view-label {
        display: block;
        text-align: center;
        margin-top: 0.75rem;
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.15em;
        text-transform: uppercase;
        color: #d4a853;
        text-shadow: 0 0 10px rgba(212, 168, 83, 0.5);
    }

    /* Markers */
    .marker {
        position: absolute;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.8);
        z-index: 10;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .marker.is-a {
        background: #000;
        border: 3px solid #d4a853; /* Gold rings? Or specific polarity color? 
       Usually (-) is Black/Blue and (+) is Red.
       But user style is Gold/Green.
       Let's stick to consistent user palette or industry standard?
       User asked for "Estilo de la web". 
       So, Point A = Gold, Point B = Green?
       Let's try: A (Norte/Negativo) usually relaxes -> Gold/Black.
       B (Sur/Positivo) usually excites -> Green/Red.
    */
        background: radial-gradient(circle at 30% 30%, #d4a853, #000);
        box-shadow: 0 0 20px rgba(212, 168, 83, 0.6);
    }

    .marker.is-b {
        background: radial-gradient(circle at 30% 30%, #4ade80, #000);
        box-shadow: 0 0 20px rgba(74, 222, 128, 0.6);
    }

    /* Pulse animation */
    .marker::after {
        content: "";
        position: absolute;
        inset: -6px;
        border: 2px solid currentColor;
        border-radius: 50%;
        opacity: 0;
        animation: pulse 2s infinite;
    }
    .marker.is-a {
        color: #d4a853;
    }
    .marker.is-b {
        color: #4ade80;
    }

    @keyframes pulse {
        0% {
            transform: scale(0.5);
            opacity: 0;
        }
        50% {
            opacity: 0.5;
        }
        100% {
            transform: scale(1.5);
            opacity: 0;
        }
    }

    .legend {
        display: flex;
        gap: 2rem;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.8);
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
    }
    .dot.a {
        background: #d4a853;
    }
    .dot.b {
        background: #4ade80;
    }
</style>
